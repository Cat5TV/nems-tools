#!/usr/local/bin/php
<?php
$v=0;
$pid=getmypid();
$user=trim(shell_exec('whoami'));
if ($user != 'root') die('Access denied: Must be root.' . PHP_EOL);

$isrunning = 0;
if (file_exists('/var/run/warninglight.pid')) {
  $pidfromfile = file_get_contents('/var/run/warninglight.pid');
  if (file_exists( "/proc/$pidfromfile" )) {
    $isrunning = 1;
  }
}

if ($isrunning == 1 && ($pid != $pidfromfile)) {
  die('Already running.' . PHP_EOL . 'Run: tail -f /var/log/nems/nems-tools/warninglight' . PHP_EOL);
}

file_put_contents('/var/run/warninglight.pid',$pid);

// Let's go!

  $conf = file('/root/nems/nems-tools/nems-tools.conf');
  if (is_array($conf) && (count($conf) > 0)) {
    foreach ($conf as $line) {
      $tmp = explode('=',$line);
      if (is_array($tmp) && (count($tmp) == 2)) {
        $stringname = $tmp[0];
        // Eg. nemsserver=127.0.0.1 in nems-tools.conf will give $nemsserver here.
        $$stringname = trim($tmp[1]);
      }
    }
  } else {
    die('Could not load nems-tools.conf.' . PHP_EOL);
  }

  if (!isset($nemsserver)) die('nemsserver missing from nems-tools.conf' . PHP_EOL);


$currentstate = ''; // First run will never match the default state
$apiresponse = 0; // 0 means API had no errors

$definitions = new stdClass();
  $definitions->{0} = 'OK';
  $definitions->{1} = 'WARNING';
  $definitions->{2} = 'CRITICAL';
  $definitions->{3} = 'UNKNOWN';

// Begin daemon loop
while (1 == 1) {

$issues = array(); // reset at each iteration
$states = query('hosts?Columns=name,state,services_with_fullstate');
foreach ($states->content as $key=>$host) {
  if (isset($host->services_with_fullstate)) {
    foreach ($host->services_with_fullstate as $services) {
      if (is_array($services) && isset($services[1])) {
        $issues[$services[1]][] = array(
          'service'=>$services[0],
          'host'=>$host->name,
          'error'=>$services[3]
        );
      }
    }
  }
}

// Only allow one state, and always default to the worst.
// Eg., if critical and warning set, we'll go with critical.
if (isset($issues[2])) {
  setstate('critical');
} elseif (isset($issues[1])) {
  setstate('warning');
} elseif (isset($issues[3])) {
  setstate('unknown');
} elseif (isset($issues[0])) {
  setstate('ok');
} else {
  $apiresponse++;
  if ($apiresponse == 5) {
    echo '[' . date('Y-m-d g:i:sa') . '] nems-api is not responding.' . PHP_EOL;
  }
  if ($apiresponse == 10) { // set light to orange and leave it there.
    echo '[' . date('Y-m-d g:i:sa') . '] nems-api is still not responding: I\'ll stop notifying.' . PHP_EOL;
  }
}

  sleep(3); // refresh the data every 30 seconds
} // end of daemon loop



// Functions

  function query($query) {
    global $nemsserver;
    $url = 'http://' . $nemsserver . '/nems-api/' . $query;
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    if ($response = curl_exec($ch)) {
      $result = json_decode($response);
    } else {
      $result = json_encode(array('error'=>'invalid query or server not responding'));
    }
    curl_close($ch);
    return ($result);
  }

function setstate($state) {
  global $issues,$currentstate,$currentissues,$v,$apiresponse;
  $apiresponse = 0; // 0 means the API had no problems.
  $previousstate = $currentstate;
  $currentstate = $state;
  $previousissues = $currentissues;
  $currentissues = '';
  // only update status if state has changed
    switch ($state) {

      case 'ok': // Green light.
        if ($currentstate != $previousstate) $currentissueshead = 'NEMS State: OK.' . PHP_EOL;
      break;

      case 'unknown': // Turn on orange light.
        if ($currentstate != $previousstate) {
          $currentissueshead = 'NEMS State: UNKNOWN.' . PHP_EOL;
        } else {
          $currentissueshead = 'Updated:' . PHP_EOL;
        }
        foreach ($issues[3] as $issue) {
          $currentissues .= '  - Service "' . $issue['service'] . '" on ' . $issue['host'] . ':' . PHP_EOL . '    ' . $issue['error'] . PHP_EOL;
        }
      break;

      case 'warning': // Turn on orange, flash or pulse red.
        if ($currentstate != $previousstate) {
          $currentissueshead = 'NEMS State: WARNING.' . PHP_EOL;
        } else {
          $currentissueshead = 'Updated:' . PHP_EOL;
        }
        foreach ($issues[2] as $issue) {
          $currentissues .= '  - Service "' . $issue['service'] . '" on ' . $issue['host'] . ':' . PHP_EOL . '    ' . $issue['error'] . PHP_EOL;
        }
        if (isset($issues[3])) {
          $currentissues .= 'Other issues:' . PHP_EOL;
          foreach ($issues[3] as $issue) {
            $currentissues .= '  - Service "' . $issue['service'] . '" on ' . $issue['host'] . ':' . PHP_EOL . '    ' . $issue['error'] . PHP_EOL;
          }
        }
      break;

      case 'critical': // Red solid light, siren for 3 seconds every 15 minutes.
        if ($currentstate != $previousstate) {
          $currentissueshead = 'NEMS State: CRITICAL.' . PHP_EOL;
        } else {
          $currentissueshead = 'Updated:' . PHP_EOL;
        }
        foreach ($issues[2] as $issue) {
          $currentissues .= '  - Service "' . $issue['service'] . '" on ' . $issue['host'] . ':' . PHP_EOL . '    ' . $issue['error'] . PHP_EOL;
        }
        if (isset($issues[1]) || isset($issues[3])) {
          $currentissues .= 'Other issues:' . PHP_EOL;
          if (isset($issues[1])) { // warnings
            foreach ($issues[1] as $issue) {
              $currentissues .= '  - Service "' . $issue['service'] . '" on ' . $issue['host'] . ':' . PHP_EOL . '    ' . $issue['error'] . PHP_EOL;
            }
          }      
          if (isset($issues[3])) { // unknown
            foreach ($issues[3] as $issue) {
              $currentissues .= '  - Service "' . $issue['service'] . '" on ' . $issue['host'] . ':' . PHP_EOL . '    ' . $issue['error'] . PHP_EOL;
            }
          }      
        }
      break;

    }
    if ($currentstate != $previousstate || $currentissues != $previousissues) {
      echo '[' . date('Y-m-d g:i:sa') . '] ' . $currentissueshead . $currentissues;
    }
  
}


unlink('/var/run/warninglight.pid');

?>
